import hashlib
import requests
import os
from typing import Optional

VIRUSTOTAL_API_KEY = os.getenv("VIRUSTOTAL_API_KEY", "")
VIRUSTOTAL_URL = "https://www.virustotal.com/api/v3"

def calculate_file_hash(file_path: str) -> dict:
    """
    Calculate MD5, SHA1, and SHA256 hashes of a file
    """
    hash_md5 = hashlib.md5()
    hash_sha1 = hashlib.sha1()
    hash_sha256 = hashlib.sha256()
    
    with open(file_path, 'rb') as f:
        for chunk in iter(lambda: f.read(4096), b''):
            hash_md5.update(chunk)
            hash_sha1.update(chunk)
            hash_sha256.update(chunk)
    
    return {
        'md5': hash_md5.hexdigest(),
        'sha1': hash_sha1.hexdigest(),
        'sha256': hash_sha256.hexdigest()
    }

def scan_file_virustotal(file_path: str) -> dict:
    """
    Scan file using VirusTotal API
    """
    if not VIRUSTOTAL_API_KEY:
        return {"error": "VirusTotal API key not configured"}
    
    try:
        # Calculate hash first
        hashes = calculate_file_hash(file_path)
        
        # Check if file already scanned
        headers = {"x-apikey": VIRUSTOTAL_API_KEY}
        response = requests.get(
            f"{VIRUSTOTAL_URL}/files/{hashes['sha256']}",
            headers=headers
        )
        
        if response.status_code == 200:
            data = response.json()
            stats = data['data']['attributes']['last_analysis_stats']
            
            return {
                "file_hash": hashes['sha256'],
                "malicious": stats['malicious'],
                "suspicious": stats['suspicious'],
                "undetected": stats['undetected'],
                "harmless": stats['harmless'],
                "total_scans": sum(stats.values()),
                "is_malware": stats['malicious'] > 0,
                "threat_level": get_threat_level(stats),
                "scan_date": data['data']['attributes']['last_analysis_date']
            }
        
        # If not found, upload for scanning
        elif response.status_code == 404:
            return upload_file_virustotal(file_path, hashes)
        
        else:
            return {"error": f"VirusTotal API error: {response.status_code}"}
            
    except Exception as e:
        return {"error": str(e)}

def upload_file_virustotal(file_path: str, hashes: dict) -> dict:
    """
    Upload file to VirusTotal for scanning
    """
    headers = {"x-apikey": VIRUSTOTAL_API_KEY}
    
    with open(file_path, 'rb') as f:
        files = {'file': f}
        response = requests.post(
            f"{VIRUSTOTAL_URL}/files",
            headers=headers,
            files=files
        )
    
    if response.status_code == 200:
        data = response.json()
        return {
            "status": "uploaded",
            "file_hash": hashes['sha256'],
            "analysis_id": data['data']['id'],
            "message": "File uploaded for analysis. Check back later for results."
        }
    else:
        return {"error": "Failed to upload file"}

def get_threat_level(stats: dict) -> str:
    """
    Determine threat level based on scan results
    """
    malicious = stats.get('malicious', 0)
    suspicious = stats.get('suspicious', 0)
    total = sum(stats.values())
    
    if total == 0:
        return "unknown"
    
    malicious_ratio = malicious / total
    suspicious_ratio = (malicious + suspicious) / total
    
    if malicious_ratio >= 0.3:
        return "critical"
    elif malicious_ratio >= 0.1:
        return "high"
    elif suspicious_ratio >= 0.2:
        return "medium"
    else:
        return "low"

def scan_url_virustotal(url: str) -> dict:
    """
    Scan URL using VirusTotal API
    """
    if not VIRUSTOTAL_API_KEY:
        return {"error": "VirusTotal API key not configured"}
    
    try:
        headers = {"x-apikey": VIRUSTOTAL_API_KEY}
        
        # Submit URL for scanning
        data = {"url": url}
        response = requests.post(
            f"{VIRUSTOTAL_URL}/urls",
            headers=headers,
            data=data
        )
        
        if response.status_code == 200:
            result = response.json()
            analysis_id = result['data']['id']
            
            # Get analysis results
            analysis_response = requests.get(
                f"{VIRUSTOTAL_URL}/analyses/{analysis_id}",
                headers=headers
            )
            
            if analysis_response.status_code == 200:
                analysis_data = analysis_response.json()
                stats = analysis_data['data']['attributes']['stats']
                
                return {
                    "url": url,
                    "malicious": stats['malicious'],
                    "suspicious": stats['suspicious'],
                    "harmless": stats['harmless'],
                    "undetected": stats['undetected'],
                    "is_malicious": stats['malicious'] > 0,
                    "threat_level": get_threat_level(stats)
                }
        
        return {"error": "Failed to scan URL"}
        
    except Exception as e:
        return {"error": str(e)}

def basic_file_analysis(file_path: str) -> dict:
    """
    Basic static analysis without external APIs
    """
    try:
        file_size = os.path.getsize(file_path)
        hashes = calculate_file_hash(file_path)
        
        # Check file extension
        _, ext = os.path.splitext(file_path)
        suspicious_extensions = ['.exe', '.dll', '.bat', '.cmd', '.vbs', '.js', '.scr']
        
        is_suspicious = ext.lower() in suspicious_extensions
        
        return {
            "file_size": file_size,
            "hashes": hashes,
            "extension": ext,
            "is_suspicious_extension": is_suspicious,
            "analysis": "Basic static analysis completed"
        }
        
    except Exception as e:
        return {"error": str(e)}